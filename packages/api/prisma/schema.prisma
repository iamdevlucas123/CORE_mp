generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Priority {
  low
  medium
  high
}

enum Role {
  owner
  member
}

model Space {
  id        Int           @id @default(autoincrement())
  name      String        @db.VarChar(120)
  createdAt DateTime      @default(now()) @map("created_at")
  projects  Project[]
  members   SpaceMember[]

  @@map("spaces")
}

model Project {
  id        Int       @id @default(autoincrement())
  spaceId   Int       @map("space_id")
  name      String    @db.VarChar(120)
  createdAt DateTime  @default(now()) @map("created_at")
  space     Space     @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  columns   Column[]
  tasks     Task[]

  @@index([spaceId])
  @@map("projects")
}

model Column {
  id        Int      @id @default(autoincrement())
  projectId Int      @map("project_id")
  name      String   @db.VarChar(80)
  position  Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks     Task[]

  @@index([projectId, position], map: "idx_columns_project_pos")
  @@map("columns")
}

model Task {
  id          Int           @id @default(autoincrement())
  projectId   Int           @map("project_id")
  columnId    Int           @map("column_id")
  title       String        @db.VarChar(255)
  description String?       @db.Text
  ticket      String?       @db.VarChar(50)
  team        String?       @db.VarChar(80)
  assignee    String?       @db.VarChar(120)
  startDate   DateTime?     @db.Date @map("start_date")
  dueDate     DateTime?     @db.Date @map("due_date")
  priority    Priority      @default(medium)
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")
  project     Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  column      Column        @relation(fields: [columnId], references: [id], onDelete: Cascade)
  comments    TaskComment[]
  activities  TaskActivity[]

  @@index([projectId, columnId], map: "idx_tasks_project_column")
  @@index([startDate, dueDate], map: "idx_tasks_dates")
  @@map("tasks")
}

model TaskComment {
  id        Int      @id @default(autoincrement())
  taskId    Int      @map("task_id")
  author    String?  @db.VarChar(120)
  body      String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@map("task_comments")
}

model TaskActivity {
  id        Int      @id @default(autoincrement())
  taskId    Int      @map("task_id")
  type      String   @db.VarChar(50)
  payload   Json?
  createdAt DateTime @default(now()) @map("created_at")
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@map("task_activity")
}

model User {
  id          Int           @id @default(autoincrement())
  email       String        @unique @db.VarChar(120)
  name        String?       @db.VarChar(120)
  createdAt   DateTime      @default(now()) @map("created_at")
  memberships SpaceMember[]

  @@map("users")
}

model SpaceMember {
  id        Int      @id @default(autoincrement())
  spaceId   Int      @map("space_id")
  userId    Int      @map("user_id")
  role      Role     @default(owner)
  createdAt DateTime @default(now()) @map("created_at")
  space     Space    @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([spaceId, userId], map: "uniq_space_member")
  @@index([userId], map: "idx_space_members_user")
  @@map("space_members")
}